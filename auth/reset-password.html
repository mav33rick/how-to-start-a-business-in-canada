<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset Password – Start a Business in Canada</title>
  
  <!-- Modular CSS Files -->
  <link rel="stylesheet" href="../src/styles/main.css" />
  <link rel="stylesheet" href="../src/styles/components.css" />
  <link rel="stylesheet" href="../src/styles/auth.css" />
  <link rel="stylesheet" href="../src/styles/responsive.css" />
  
  <!-- Supabase Client from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1><a href="../index.html">Start a Business in Canada</a></h1>
      <div class="sub">Reset Password</div>
    </div>
  </header>

  <div class="layout wrap">
    <section style="max-width: 500px; margin: 0 auto;">
      <div class="card">
        <div id="resetForm">
          <div style="padding: 30px;">
            <h2 style="margin-bottom: 20px;">Set New Password</h2>
            <p class="muted" style="margin-bottom: 30px;">Enter your new password below.</p>
            
            <div id="resetError" class="auth-error" style="display: none;"></div>
            <div id="resetSuccess" class="auth-success" style="display: none;"></div>
            
            <form id="passwordResetForm">
              <div class="auth-field">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" required minlength="6" autocomplete="new-password">
              </div>
              
              <div class="auth-field">
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" id="confirmPassword" required minlength="6" autocomplete="new-password">
              </div>
              
              <button type="submit" id="updatePasswordBtn" class="auth-btn auth-btn-primary">
                Update Password
              </button>
            </form>
            
            <div style="text-align: center; margin-top: 20px;">
              <a href="../index.html" class="auth-link">Back to App</a>
            </div>
          </div>
        </div>
        
        <div id="resetSuccess" style="display: none;">
          <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 48px; margin-bottom: 20px;">✅</div>
            <h2>Password updated successfully!</h2>
            <p class="muted">You can now sign in with your new password.</p>
            <div style="margin-top: 30px;">
              <a href="../index.html" class="btn primary">Continue to App</a>
            </div>
          </div>
        </div>
        
        <div id="resetError" style="display: none;">
          <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
            <h2>Reset failed</h2>
            <p class="muted" id="errorMessage">There was an error resetting your password.</p>
            <div style="margin-top: 30px;">
              <a href="../index.html" class="btn ghost">Back to App</a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import { supabaseConfig } from '../src/config/supabase-config.js';
    
    let supabase;
    
    async function initializeSupabase() {
      supabase = window.supabase.createClient(
        supabaseConfig.url, 
        supabaseConfig.anonKey
      );
    }
    
    function showError(message) {
      const errorEl = document.getElementById('resetError');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      document.getElementById('resetSuccess').style.display = 'none';
    }
    
    function showSuccess(message) {
      const successEl = document.getElementById('resetSuccess');
      successEl.textContent = message;
      successEl.style.display = 'block';
      document.getElementById('resetError').style.display = 'none';
    }
    
    function setLoading(loading) {
      const button = document.getElementById('updatePasswordBtn');
      const form = document.getElementById('passwordResetForm');
      
      if (loading) {
        button.disabled = true;
        button.textContent = 'Updating...';
        form.style.opacity = '0.6';
      } else {
        button.disabled = false;
        button.textContent = 'Update Password';
        form.style.opacity = '1';
      }
    }
    
    async function handlePasswordReset(event) {
      event.preventDefault();
      
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Clear previous messages
      document.getElementById('resetError').style.display = 'none';
      document.getElementById('resetSuccess').style.display = 'none';
      
      // Validate passwords
      if (newPassword !== confirmPassword) {
        showError('Passwords do not match.');
        return;
      }
      
      if (newPassword.length < 6) {
        showError('Password must be at least 6 characters long.');
        return;
      }
      
      setLoading(true);
      
      try {
        // Check if user is authenticated via reset token
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
          throw new Error('Invalid or expired reset link. Please request a new password reset.');
        }
        
        // Update the password
        const { error } = await supabase.auth.updateUser({
          password: newPassword
        });
        
        if (error) {
          throw error;
        }
        
        // Success
        document.getElementById('resetForm').style.display = 'none';
        document.getElementById('resetSuccess').style.display = 'block';
        
        // Auto-redirect after a few seconds
        setTimeout(() => {
          window.location.href = '../index.html';
        }, 3000);
        
      } catch (error) {
        console.error('Password reset error:', error);
        showError(error.message || 'There was an error updating your password.');
      } finally {
        setLoading(false);
      }
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', async () => {
      await initializeSupabase();
      
      // Set up form handler
      document.getElementById('passwordResetForm').addEventListener('submit', handlePasswordReset);
      
      // Check if this is a valid reset session
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          // Invalid session, show error
          document.getElementById('resetForm').style.display = 'none';
          document.getElementById('resetError').style.display = 'block';
          document.getElementById('errorMessage').textContent = 
            'Invalid or expired reset link. Please request a new password reset from the app.';
        }
      } catch (error) {
        console.error('Session check error:', error);
      }
    });
  </script>
</body>
</html>